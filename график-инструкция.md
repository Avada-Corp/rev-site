# Инструкция по построению графиков отчетов на бэкенде

## Источник данных

### API Эндпоинты
1. **Основной эндпоинт для получения отчетов:**
   - URL: `POST /api/getPnlReports`
   - Тело запроса: `{ from: number, to: number, email: string | null }`
   - Возвращает: `NewReport[]`

2. **Альтернативный эндпоинт для отчетов без сомнений:**
   - URL: `POST /api/getSoloPnlReportsWithoutDoubts` 
   - Тело запроса: `{ from: number, to: number, email: string }`
   - Возвращает: `NewReport[]`

### Структура данных NewReport
```typescript
interface NewReport {
  start: number;        // Дата начала периода (timestamp)
  to: number;           // Дата окончания периода (timestamp)
  transfers: Transfers | null;
  totalBalance: number; // Общий баланс
  pnl: number;         // Накопительный PNL
  pnlDaily: number;    // Ежедневный PNL
  username: string;    // Имя пользователя
  keyId: string;       // ID ключа API
  apiName: string;     // Название API
  tgAccount: string;   // Telegram аккаунт
  api: Omit<ApiWithEmail, 'name'>; // Данные API
}
```

## Обработка данных

### 1. Фильтрация данных
Перед построением графиков данные фильтруются по:
- `username` - имя пользователя
- `api.key` - ключ API (для группировки по конкретному API)

```typescript
const filteredReports = reports.filter(
  (report) => 
    report.username === targetUsername && 
    report.api.key === targetApiKey
);
```

### 2. Сортировка по дате
```typescript
const sortedReports = filteredReports.sort((a, b) => {
  const dateA = a.to ? new Date(a.to).getTime() : 0;
  const dateB = b.to ? new Date(b.to).getTime() : 0;
  return dateA - dateB;
});
```

### 3. Ограничение количества
```typescript
// Ограничение до 50 записей для производительности
const limitedReports = sortedReports.slice(0, 50);
```

## Построение графиков

### График 1: "Общий баланс" (totalBalance)
```typescript
const totalBalanceChart = {
  labels: sortedReports.map(report => 
    report.to ? new Date(report.to).toLocaleDateString() : 'Неизвестно'
  ),
  datasets: [{
    label: 'Общий баланс',
    backgroundColor: 'rgba(75, 192, 192, 0.2)',
    borderColor: 'rgb(75, 192, 192)',
    borderWidth: 2,
    fill: true,
    tension: 0.4,
    data: sortedReports.map(report => report.totalBalance || 0)
  }]
}
```

### График 2: "Ежедневный PNL" (pnlDaily)
```typescript
const pnlDailyChart = {
  labels: sortedReports.map(report => 
    report.to ? new Date(report.to).toLocaleDateString() : 'Неизвестно'
  ),
  datasets: [{
    label: 'Ежедневный PNL',
    backgroundColor: 'rgba(75, 192, 192, 0.2)',
    borderColor: 'rgb(75, 192, 192)',
    borderWidth: 2,
    fill: true,
    tension: 0.4,
    data: sortedReports.map(report => report.pnlDaily || 0)
  }]
}
```

### График 3: "PNL накопительный" (pnl)
```typescript
const pnlChart = {
  labels: sortedReports.map(report => 
    report.to ? new Date(report.to).toLocaleDateString() : 'Неизвестно'
  ),
  datasets: [{
    label: 'PNL',
    backgroundColor: 'rgba(75, 192, 192, 0.2)',
    borderColor: 'rgb(75, 192, 192)',
    borderWidth: 2,
    fill: true,
    tension: 0.4,
    data: sortedReports.map(report => report.pnl || 0)
  }]
}
```

## Дополнительные вычисления

### Расчет изменения баланса
```typescript
function getTotalBalanceChange(currentIndex: number, reports: NewReport[]) {
  const currentReport = reports[currentIndex];
  const currentBalance = currentReport.totalBalance || 0;
  
  if (currentIndex <= 0) {
    return currentBalance;
  }
  
  const previousReport = reports[currentIndex - 1];
  const diff = currentBalance - (previousReport.totalBalance || 0);
  
  return {
    current: currentBalance,
    change: diff,
    formatted: `${currentBalance.toFixed(2)} ${
      diff !== 0 ? `(${diff > 0 ? '+' : ''}${diff.toFixed(2)})` : ''
    }`
  };
}
```

### Расчет дельты
```typescript
function getDelta(currentIndex: number, reports: NewReport[]) {
  const currentReport = reports[currentIndex];
  const pnlDaily = currentReport.pnlDaily || 0;
  const currentPnl = currentReport.pnl || 0;
  
  if (currentIndex <= 0) {
    return pnlDaily + currentPnl;
  }
  
  const previousReport = reports[currentIndex - 1];
  const previousPnl = previousReport.pnl || 0;
  
  return pnlDaily + currentPnl - previousPnl;
}
```

## Настройки графиков

### Общие опции Chart.js
```typescript
const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  animation: {
    duration: 500,
  },
  plugins: {
    legend: {
      display: true,
      position: 'top',
      labels: {
        boxWidth: 20,
        font: {
          size: 12,
        },
      },
    },
    tooltip: {
      enabled: true,
      mode: 'index',
      intersect: false,
    },
  },
  scales: {
    x: {
      display: true,
      ticks: {
        font: {
          size: 11,
        },
      },
    },
    y: {
      display: true,
      beginAtZero: false,
      ticks: {
        font: {
          size: 11,
        },
      },
    },
  },
}
```

## Логика работы приложения

1. **Получение данных:** Запрос к API `/api/getPnlReports` или `/api/getSoloPnlReportsWithoutDoubts`
2. **Фильтрация:** По username и api.key для конкретного пользователя/API
3. **Сортировка:** По дате (поле `to`) по возрастанию
4. **Ограничение:** Максимум 50 записей
5. **Построение графиков:** 3 отдельных графика с одинаковыми метками дат
6. **Отображение:** Использование Chart.js с настройками выше

## Ключевые особенности

- **Обработка null/undefined:** Все числовые поля приводятся к 0
- **Формат дат:** `toLocaleDateString()` для меток по оси X
- **Производительность:** Ограничение до 50 записей
- **Группировка:** По пользователю и API ключу
- **Сравнение:** Расчет изменений между соседними записями

## Пример полного процесса

```typescript
// 1. Получение данных
const response = await fetch('/api/getPnlReports', {
  method: 'POST',
  body: JSON.stringify({ from: startDate, to: endDate, email: userEmail }),
  headers: { 'Content-Type': 'application/json' }
});
const { data: reports } = await response.json();

// 2. Обработка
const filteredReports = reports
  .filter(r => r.username === username && r.api.key === apiKey)
  .sort((a, b) => (a.to || 0) - (b.to || 0))
  .slice(0, 50);

// 3. Построение графиков
const charts = {
  totalBalance: buildChart(filteredReports, 'totalBalance', 'Общий баланс'),
  pnlDaily: buildChart(filteredReports, 'pnlDaily', 'Ежедневный PNL'),
  pnl: buildChart(filteredReports, 'pnl', 'PNL')
};
``` 