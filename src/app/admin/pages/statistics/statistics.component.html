<app-date-range-select [rangeDates]="getLastClosedWeekDates()" [dispatchFunc]="getReports" (getEvent)="clickRange()"
  [email]="null"></app-date-range-select>

<!-- Индикатор обработки данных -->
<div *ngIf="isProcessingData" class="processing-indicator">
  <div class="spinner"></div>
  <span>Обработка данных... {{processingProgress.current}} из {{processingProgress.total}} пользователей</span>
</div>

<div class="commission-filter-container" *ngIf="fullReports.length > 0">
  <p-dropdown [options]="commissionFilterOptions" [(ngModel)]="selectedCommissionFilter"
    (onChange)="filterReportsByCommission()" placeholder="Фильтр по комиссии"></p-dropdown>
  {{filteredReports.length}} из {{fullReports.length}}
</div>

<!-- Main Reports Table -->
<p-table class="report-table" [value]="filteredReports" dataKey="username" rowGroupMode="subheader"
  groupRowsBy="username" [scrollable]="true" scrollHeight="700px" [tableStyle]="{'min-width': '70rem'}">
  <ng-template pTemplate="header">
    <tr>
      <th>Api name</th>
      <th>Доступный баланс (начало)</th>
      <th>Пнл (начало)</th>
      <th>Общий баланс (начало)</th>
      <th class="darker">Доступный баланс (конец)</th>
      <th class="darker">Пнл (конец)</th>
      <th class="darker">Общий баланс (конец)</th>
      <th>Трансферы</th>
      <th>Сдельный пнл</th>
      <th>Итого (сдельное)</th>
      <th>Действия</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="groupheader" let-report let-rowIndex="rowIndex" let-expanded="expanded">
    <tr>
      <td colspan="11">
        <button type="button" pButton pRipple [pRowToggler]="report"
          class="p-button-text p-button-rounded p-button-plain mr-2"
          [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
        <span class="font-bold ml-2">{{report.username}}</span>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="groupfooter" let-report>
    <tr class="p-rowgroup-footer lighted">
      <td>Итого <b>{{report.username}}</b></td>
      <td colspan="2">Общий баланс: {{ getTotalVal(report, "totalBalance").toFixed(2) }}</td>
      <td colspan="2">Общий пнл: {{ getTotalVal(report, "pnl").toFixed(2) }}</td>
      <td colspan="2">Общая сумма трансферов: {{ (getTotalVal(report, "transfers") * -1).toFixed(2) }}</td>
      <td colspan="4">Итого за период: {{ getTotalVal(report, "totalDaily").toFixed(2) }}</td>
    </tr>
  </ng-template>
  <ng-template pTemplate="rowexpansion" let-report>
    <tr>
      <td (click)="onOpenControlBtns(report)" class="apiName">{{ report.apiName }}</td>
      <td class="lgray">{{ toFixed(report.avalBalanceStart) }}</td>
      <td class="lgray">{{ toFixed(report.pnlStart) }}</td>
      <td class="lgray">{{ toFixed(report.totalBalanceStart) }}</td>
      <td class="darker">{{ toFixed(report.avalBalance) }}</td>
      <td class="darker">{{ toFixed(report.pnl) }}</td>
      <td class="darker">{{ toFixed(report.totalBalance) }}</td>
      <td class="lgray">{{report.transfers * -1}}</td>
      <td class="lgray">{{ report.pnlDaily?.toFixed(2) ?? "" }}</td>
      <td class="lgray">{{ report.totalDaily?.toFixed(2) ?? "" }} ({{toFixed(report.total)}})</td>
      <td>
        <p-button icon="pi pi-chart-line" styleClass="p-button-rounded p-button-text p-button-sm"
          (click)="openChartDialog(report, $event)"></p-button>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="summary">
    <tr *ngIf="filteredReports.length > 0" class="footerRow">
      <td>Общий баланс по отчетам: {{ getAllTotalVal("totalBalance").toFixed(2) }}</td>
      <td>Общий пнл по отчетам: {{ getAllTotalVal("pnl").toFixed(2) }}</td>
      <td>Общая сумма трансферов: {{ (getAllTotalVal("transfers") * -1).toFixed(2) }}</td>
      <td>Итого за период по отчетам: {{ getAllTotalVal("totalDaily").toFixed(2) }}</td>
    </tr>
  </ng-template>
</p-table>
<p-dialog header="Control Btns" [(visible)]="isControlBtns" (onHide)="onHideControlBtns()" [modal]="true"
  [style]="{width: '50vw'}">
  <div *ngIf="curReport != null" class="controlBtns">
    <div class="dataBtns">
      <p-button class="addBot" icon="pi pi-database" styleClass="p-button-warning"
        (click)="controlApiService.actualizeBotsInfo(getApiInfoFromReport(curReport))"></p-button>
      <p-button class="addBot" icon="pi pi-sliders-v" styleClass="p-button-warning"
        (click)="controlApiService.actualizeBotsNotStartInfo(getApiInfoFromReport(curReport))"></p-button>
      <p-button class="addBot" icon="pi pi-sync" styleClass="p-button-success"
        (click)="controlApiService.updateBotsInfo(getApiInfoFromReport(curReport))"></p-button>
    </div>
    <div class="mngBots">
      <p-button class="addBot" icon="pi pi-pencil" styleClass="p-button-danger" (click)="isEditForm = true">
      </p-button>
      <p-button class="addBot" icon="pi pi-times" styleClass="p-button-danger"
        (click)="controlApiService.deleteApi(getApiInfoFromReport(curReport))">
      </p-button>
      <p-button class="addBot" icon="pi pi-play" styleClass="p-button-success"
        (click)="controlApiService.startApi(getApiInfoFromReport(curReport))">
      </p-button>
      <p-button class="addBot" icon="pi pi-pause" styleClass="p-button-danger"
        (click)="controlApiService.stopApi(getApiInfoFromReport(curReport))">
      </p-button>
      <p-button class="addBot" icon="pi pi-circle" styleClass="p-button-danger"
        (click)="controlApiService.fullStopApi(getApiInfoFromReport(curReport))">
      </p-button>
    </div>
  </div>
  <app-refferal-grid *ngIf="this.curReport && this.curReport.tgAccount"
    [accountId]="this.curReport.tgAccount"></app-refferal-grid>
</p-dialog>
<button (click)="saveReportsToFile()">Сохранить отчеты в файл</button>
<p-dialog header="Edit Api" [(visible)]="isEditForm" [style]="{width: '50vw'}">
  <app-edit-user-api *ngIf="curReport != null" (closeFormEvent)="isEditForm = false"
    [api]="getApiInfoFromReport(curReport)"></app-edit-user-api>
</p-dialog>

<!-- Chart Dialog -->
<p-dialog header="Отчеты пользователя {{currentUsername}}" [(visible)]="isChartDialogVisible" [modal]="true"
  [style]="{width: '90vw', maxHeight: '90vh'}" [resizable]="false" [draggable]="true" (onHide)="closeChartDialog()">
  <app-report-chart [reports]="getFilteredReportsForCurrentApi()" [username]="currentUsername"
    *ngIf="getFilteredReportsForCurrentApi().length > 0"></app-report-chart>
</p-dialog>