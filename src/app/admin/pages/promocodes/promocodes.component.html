<div class="promocodes-container">
    <div class="header">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏</h2>
        <button type="button" class="btn btn-primary" (click)="toggleGenerateForm()">
            {{ showGenerateForm ? '–û—Ç–º–µ–Ω–∞' : '–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã' }}
        </button>
    </div>

    <!-- –§–æ—Ä–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
    <div class="generate-form-container" *ngIf="showGenerateForm">
        <div class="card">
            <div class="card-header">
                <h3>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</h3>
            </div>
            <div class="card-body">
                <form [formGroup]="generateForm" (ngSubmit)="onGeneratePromocodes()">
                    <!-- –ü–æ–ª–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="personalCode">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥</label>
                                <input type="text" id="personalCode" class="form-control" formControlName="personalCode"
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                                <div class="invalid-feedback"
                                    *ngIf="generateForm.get('personalCode')?.touched && generateForm.get('personalCode')?.errors">
                                    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
                                </div>
                                <small class="form-text text-muted">
                                    –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω 1 –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–¥–æ–º
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="amount">–°—É–º–º–∞ *</label>
                                <input type="number" id="amount" class="form-control" formControlName="amount"
                                    step="0.01" min="0.01" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" #amountInput
                                    (blur)="formatMoneyInput(amountInput)">
                                <div class="invalid-feedback"
                                    *ngIf="generateForm.get('amount')?.touched && generateForm.get('amount')?.errors">
                                    –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                                <input type="number" id="count" class="form-control" formControlName="count" min="1"
                                    max="100" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                                <div class="invalid-feedback"
                                    *ngIf="generateForm.get('count')?.touched && generateForm.get('count')?.errors">
                                    –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç 1 –¥–æ 100
                                </div>
                                <small class="form-text text-muted" *ngIf="generateForm.get('personalCode')?.value">
                                    –î–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ 1
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="isReusable" class="form-check-input"
                                        formControlName="isReusable">
                                    <label class="form-check-label" for="isReusable">
                                        –ú–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥
                                    </label>
                                </div>
                                <small class="form-text text-muted" *ngIf="generateForm.get('personalCode')?.value">
                                    –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —è–≤–ª—è–µ—Ç—Å—è –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–º
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="usageLimit">–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label>
                                <input type="number" id="usageLimit" class="form-control" formControlName="usageLimit"
                                    min="1" placeholder="–ë–µ–∑ –ª–∏–º–∏—Ç–∞">
                                <small class="form-text text-muted">
                                    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="expirationDate">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                                <input type="date" id="expirationDate" class="form-control"
                                    formControlName="expirationDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="referralUser">–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ä–µ—Ñ–µ—Ä–∞–ª—É</label>
                                <ng-container *ngIf="usersLoaded; else loadingUsers">
                                    <p-dropdown formControlName="referralUser" [options]="(usernames$ | async) || []"
                                        optionLabel="email" optionValue="email" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                                        [showClear]="true" [filter]="true" filterBy="email,username"
                                        [style]="{'width': '100%'}">
                                        <ng-template let-user pTemplate="item">
                                            <div class="user-item">
                                                <span class="user-email">{{ user.email }}</span>
                                                <span class="user-name" *ngIf="user.username">({{ user.username
                                                    }})</span>
                                            </div>
                                        </ng-template>
                                    </p-dropdown>
                                </ng-container>

                                <ng-template #loadingUsers>
                                    <select class="form-control" formControlName="referralUser" [disabled]="true">
                                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</option>
                                    </select>
                                </ng-template>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-success"
                            [disabled]="!generateForm.valid || (isLoading$ | async)">
                            <span *ngIf="isLoading$ | async" class="spinner-border spinner-border-sm me-2"></span>
                            –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" (click)="toggleGenerateForm()">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
    <div class="promocodes-table">
        <div class="card">
            <div class="card-header">
                <h3>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã</h3>
            </div>
            <div class="card-body">
                <div *ngIf="isLoading$ | async" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>

                <div *ngIf="!(isLoading$ | async)" class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>–ö–æ–¥</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–¢–∏–ø</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</th>
                                <th>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</th>
                                <th>–†–µ—Ñ–µ—Ä–∞–ª</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let promocode of promocodes$ | async">
                                <td>
                                    <span class="promocode-text">{{ promocode.code }}</span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2"
                                        (click)="copyToClipboard(promocode.code)" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                                        üìã
                                    </button>
                                </td>
                                <td>{{ (promocode.amount / 100) | currency:'USD':'symbol':'1.2-2' }}</td>
                                <td>
                                    <span class="badge" [class]="promocode.isReusable ? 'bg-info' : 'bg-warning'">
                                        {{ promocode.isReusable ? '–ú–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–π' : '–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge" [class]="getStatusClass(promocode)">
                                        {{ getStatusText(promocode) }}
                                    </span>
                                </td>
                                <td>
                                    {{ promocode.currentUsage }}
                                    <span *ngIf="promocode.usageLimit">/ {{ promocode.usageLimit }}</span>
                                    <span *ngIf="!promocode.usageLimit && promocode.isReusable">/ ‚àû</span>
                                </td>
                                <td>
                                    <span *ngIf="promocode.expirationDate; else noExpiration">
                                        {{ formatDate(promocode.expirationDate) }}
                                    </span>
                                    <ng-template #noExpiration>
                                        <span class="text-muted">–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</span>
                                    </ng-template>
                                </td>
                                <td>
                                    <span *ngIf="promocode.referralUser; else noReferral">
                                        {{ promocode.referralUser }}
                                    </span>
                                    <ng-template #noReferral>
                                        <span class="text-muted">–ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏</span>
                                    </ng-template>
                                </td>
                                <td>{{ formatDate(promocode.createdAt) }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary"
                                            (click)="copyToClipboard(promocode.code)">
                                            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning"
                                            *ngIf="promocode.isActive" (click)="deactivatePromocode(promocode.id)"
                                            [disabled]="(isLoading$ | async)" title="–û—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥">
                                            –û—Ç–∫–ª—é—á–∏—Ç—å
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success"
                                            *ngIf="!promocode.isActive" (click)="activatePromocode(promocode.id)"
                                            [disabled]="(isLoading$ | async)" title="–í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥">
                                            –í–∫–ª—é—á–∏—Ç—å
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                            (click)="deletePromocode(promocode.id)" [disabled]="(isLoading$ | async)"
                                            title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥">
                                            –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr *ngIf="(promocodes$ | async)?.length === 0">
                                <td colspan="9" class="text-center text-muted">
                                    –ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>